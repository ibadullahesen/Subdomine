<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Cosmic Saturn - Peta Scale Adjusted</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --neon-blue: #00f2ff;
            --deep-space: #010103;
            --glow-gold: #ffdd00;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--deep-space);
            font-family: 'Segoe UI', sans-serif;
        }

        #input_video { display: none; }
        
        #canvas-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        #hand-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            pointer-events: none;
            opacity: 0.25;
            transform: scaleX(-1);
        }

        .ui-overlay {
            position: absolute;
            top: 30px; left: 30px;
            z-index: 10;
            pointer-events: none;
            color: white;
            text-shadow: 0 0 20px var(--neon-blue);
        }

        .status-badge {
            background: rgba(0, 242, 255, 0.05);
            border-left: 4px solid var(--neon-blue);
            padding: 15px 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.15);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-badge.gaming {
            border-left-color: var(--glow-gold);
            box-shadow: 0 0 40px rgba(255, 221, 0, 0.25);
            text-shadow: 0 0 20px var(--glow-gold);
        }

        #loading-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--neon-blue);
            letter-spacing: 10px;
            font-weight: bold;
            text-shadow: 0 0 15px var(--neon-blue);
        }

        #axtarget-ui {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-size: 8rem;
            font-weight: 900;
            color: #fff;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 20px var(--neon-blue), 0 0 40px var(--neon-blue);
            letter-spacing: 15px;
            text-transform: uppercase;
        }

        #axtarget-ui.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.2);
            animation: glitch 0.2s infinite;
        }

        @keyframes glitch {
            0% { text-shadow: 4px 0 red, -4px 0 blue; }
            50% { text-shadow: -4px 0 red, 4px 0 blue; }
            100% { text-shadow: 4px 0 red, -4px 0 blue; }
        }
    </style>
</head>
<body>

    <div id="loading-screen">PETA SİSTEM YÜKLƏNİR...</div>
    <div id="axtarget-ui">AxtarGet</div>

    <div class="ui-overlay">
        <div id="status-badge" class="status-badge">
            <div style="font-size: 0.8rem; opacity: 0.7; letter-spacing: 3px;">PETA KOSMİK STRUKTUR</div>
            <div style="font-size: 1.8rem; font-weight: 300;" id="mode-text">ƏL GÖZLƏNİLİR</div>
        </div>
    </div>

    <video id="input_video"></video>
    <canvas id="hand-overlay"></canvas>
    <div id="canvas-container"></div>

    <script>
        const videoElement = document.getElementById('input_video');
        const modeText = document.getElementById('mode-text');
        const statusBadge = document.getElementById('status-badge');
        const loadingScreen = document.getElementById('loading-screen');
        const axtargetUI = document.getElementById('axtarget-ui');
        const handCanvas = document.getElementById('hand-overlay');
        const handCtx = handCanvas.getContext('2d');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 5000);
        const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Hissəcik sayı 90,000
        const maxParticles = 90000; 
        const planetRadius = 28.0; 
        const ringInnerRadius = 34.0; 
        const ringOuterRadius = 52.0; 

        const particlesGeometry = new THREE.BufferGeometry();
        const posArray = new Float32Array(maxParticles * 3);
        const targetPosArray = new Float32Array(maxParticles * 3);
        const velocityArray = new Float32Array(maxParticles * 3); 

        for(let i=0; i < maxParticles; i++) {
            const i3 = i * 3;
            posArray[i3] = (Math.random() - 0.5) * 600;
            posArray[i3+1] = (Math.random() - 0.5) * 600;
            posArray[i3+2] = (Math.random() - 0.5) * 600;

            if (i < 55000) {
                const phi = Math.acos(-1 + (2 * i) / 55000);
                const theta = Math.sqrt(55000 * Math.PI) * phi;
                targetPosArray[i3] = planetRadius * Math.cos(theta) * Math.sin(phi);
                targetPosArray[i3+1] = planetRadius * Math.sin(theta) * Math.sin(phi);
                targetPosArray[i3+2] = planetRadius * Math.cos(phi);
            } else {
                const angle = Math.random() * Math.PI * 2;
                const radius = ringInnerRadius + Math.random() * (ringOuterRadius - ringInnerRadius);
                targetPosArray[i3] = Math.cos(angle) * radius;
                targetPosArray[i3+1] = (Math.random() - 0.5) * 2.0; 
                targetPosArray[i3+2] = Math.sin(angle) * radius;
            }
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.18,
            color: 0x00f2ff,
            transparent: true,
            opacity: 0,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            sizeAttenuation: true
        });

        const particleMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particleMesh);

        // Saturn cüzi uzaqlaşdırıldı (45 -> 52)
        camera.position.z = 52; 

        let formationProgress = 0; 
        let isExploding = false;
        let explosionLife = 0;
        let lastAvgDist = 0;
        let fingerTarget = new THREE.Vector3(0, 0, 0);
        let isSingleFingerActive = false;

        function animate() {
            requestAnimationFrame(animate);

            const positions = particlesGeometry.attributes.position.array;
            const activeCount = Math.floor(formationProgress * maxParticles);
            const time = Date.now() * 0.001;
            
            if (isExploding) {
                particlesMaterial.opacity = explosionLife;
                explosionLife *= 0.985;
                if (explosionLife < 0.01) isExploding = false;
            } else {
                const targetColor = isSingleFingerActive && formationProgress < 0.3 ? 0xffdd00 : 0x00f2ff;
                particlesMaterial.color.lerp(new THREE.Color(targetColor), 0.05);
                particlesMaterial.opacity = THREE.MathUtils.lerp(particlesMaterial.opacity, Math.max(0.45, formationProgress), 0.1);
            }

            for(let i=0; i < maxParticles; i++) {
                const i3 = i * 3;
                
                if (isExploding) {
                    positions[i3] += velocityArray[i3];
                    positions[i3+1] += velocityArray[i3+1];
                    positions[i3+2] += velocityArray[i3+2];
                    velocityArray[i3] *= 0.995;
                } else {
                    if (isSingleFingerActive && formationProgress < 0.3) {
                        const dx = fingerTarget.x - positions[i3];
                        const dy = fingerTarget.y - positions[i3+1];
                        const dz = fingerTarget.z - positions[i3+2];
                        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        
                        if (dist < 40) {
                            const attraction = (40 - dist) / 250;
                            positions[i3] += dx * attraction;
                            positions[i3+1] += dy * attraction;
                            positions[i3+2] += dz * attraction;
                        }
                    }

                    if (i < activeCount) {
                        const lerpSpeed = 0.04 + (formationProgress * 0.04);
                        positions[i3] += (targetPosArray[i3] - positions[i3]) * lerpSpeed;
                        positions[i3+1] += (targetPosArray[i3+1] - positions[i3+1]) * lerpSpeed;
                        positions[i3+2] += (targetPosArray[i3+2] - positions[i3+2]) * lerpSpeed;
                    } else {
                        positions[i3] += Math.sin(time * 0.5 + i) * 0.08;
                        positions[i3+1] += Math.cos(time * 0.5 + i) * 0.08;
                    }
                }
            }
            particlesGeometry.attributes.position.needsUpdate = true;

            if (!isExploding) {
                const rotSpeed = isSingleFingerActive ? 0.02 : 0.003;
                particleMesh.rotation.y += rotSpeed;
                particleMesh.rotation.x = THREE.MathUtils.lerp(particleMesh.rotation.x, 0.4, 0.02);
            }

            renderer.render(scene, camera);
        }

        function triggerExplosion(force = 1) {
            isExploding = true;
            explosionLife = 1.0;
            const positions = particlesGeometry.attributes.position.array;
            for(let i=0; i < maxParticles; i++) {
                const i3 = i * 3;
                const dx = positions[i3], dy = positions[i3+1], dz = positions[i3+2];
                const mag = Math.sqrt(dx*dx + dy*dy + dz*dz) || 1;
                const push = 6.0 * force * (Math.random() + 0.5);
                velocityArray[i3] = (dx / mag) * push;
                velocityArray[i3+1] = (dy / mag) * push;
                velocityArray[i3+2] = (dz / mag) * push;
            }
        }

        function checkAxtarGetGesture(hand) {
            return hand[8].y < hand[6].y && hand[12].y < hand[10].y && hand[16].y > hand[14].y && hand[20].y > hand[18].y;
        }

        function onResults(results) {
            if (loadingScreen.style.display !== 'none') loadingScreen.style.display = 'none';

            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
            handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                drawConnectors(handCtx, hand, HAND_CONNECTIONS, {color: isSingleFingerActive ? '#ffdd00' : '#00f2ff', lineWidth: 2});
                drawLandmarks(handCtx, hand, {color: '#ffffff', lineWidth: 1, radius: 2});

                if (checkAxtarGetGesture(hand)) axtargetUI.classList.add('active');
                else axtargetUI.classList.remove('active');

                const indexTip = hand[8];
                isSingleFingerActive = (indexTip.y < hand[6].y) && (hand[12].y > hand[10].y) && (hand[16].y > hand[14].y) && (hand[20].y > hand[18].y);
                
                if (isSingleFingerActive) {
                    fingerTarget.x = (0.5 - indexTip.x) * 140;
                    fingerTarget.y = (0.5 - indexTip.y) * 80;
                    fingerTarget.z = 25;
                }

                const wrist = hand[0];
                const tips = [hand[8], hand[12], hand[16], hand[20]];
                let distSum = 0;
                tips.forEach(t => distSum += Math.sqrt(Math.pow(t.x - wrist.x, 2) + Math.pow(t.y - wrist.y, 2)));
                const avgDist = distSum / 4;

                const velocity = avgDist - lastAvgDist;
                if (velocity > 0.04 && formationProgress > 0.6) {
                    triggerExplosion(velocity * 120);
                    formationProgress = 0;
                    lastAvgDist = avgDist;
                    return;
                }

                const minFistDist = 0.12; 
                const maxOpenDist = 0.38; 
                let targetStrength = 1 - ((avgDist - minFistDist) / (maxOpenDist - minFistDist));
                targetStrength = Math.max(0, Math.min(1, targetStrength));

                formationProgress = THREE.MathUtils.lerp(formationProgress, targetStrength, 0.15);
                if (formationProgress > 0.45) isExploding = false;

                lastAvgDist = avgDist;
                
                if (isSingleFingerActive && formationProgress < 0.3) {
                    modeText.innerText = "PETA SİSTEM MANİPULYASİYASI";
                    statusBadge.classList.add('gaming');
                } else {
                    modeText.innerText = isExploding ? "PETA NOVA PARTLAYIŞI" : `STRUKTUR GÜCÜ: %${Math.round(formationProgress * 100)}`;
                    statusBadge.classList.remove('gaming');
                }
            } else {
                formationProgress = THREE.MathUtils.lerp(formationProgress, 0, 0.05);
                isSingleFingerActive = false;
                modeText.innerText = "ƏL GÖZLƏNİLİR";
                statusBadge.classList.remove('gaming');
                axtargetUI.classList.remove('active');
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        hands.onResults(onResults);

        const cameraStream = new Camera(videoElement, {
            onFrame: async () => await hands.send({ image: videoElement }),
            width: 1280, height: 720
        });

        window.onload = () => {
            cameraStream.start();
            animate();
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
