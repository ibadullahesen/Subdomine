<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybernetic Symbiote</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --neon-cyan: #00ffff;
            --venom-purple: #bc00ff;
            --bg-black: #050505;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-black);
            font-family: 'Courier New', Courier, monospace;
        }

        #input_video { display: none; }
        
        #canvas-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        #hand-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            pointer-events: none;
            opacity: 0.3;
            transform: scaleX(-1);
        }

        .hud {
            position: absolute;
            top: 30px; left: 30px;
            z-index: 10;
            color: var(--neon-cyan);
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .status-box {
            border-left: 2px solid var(--neon-cyan);
            padding: 10px 20px;
            background: rgba(0, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }

        .warning-mode {
            color: var(--venom-purple);
            border-left-color: var(--venom-purple);
            background: rgba(188, 0, 255, 0.05);
            animation: blink 0.5s infinite alternate;
        }

        @keyframes blink {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        #glitch-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 5;
            display: none;
        }

        #loading-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--neon-cyan);
            text-align: center;
            padding: 20px;
        }

        .error-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--neon-cyan);
            color: black;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div id="load-text">SİSTEM İNİSİALİZASİYA OLUNUR...</div>
        <div style="font-size: 0.7rem; margin-top: 10px; opacity: 0.5;">(WebGL və Kamera yoxlanılır)</div>
    </div>
    <div id="glitch-overlay"></div>

    <div class="hud">
        <div id="status-box" class="status-box">
            <div style="font-size: 0.7rem; opacity: 0.6;">Simbiont Core v2.2</div>
            <div id="mode-label" style="font-size: 1.2rem; font-weight: bold;">Skaner Gözlənilir</div>
        </div>
    </div>

    <video id="input_video" playsinline></video>
    <canvas id="hand-overlay"></canvas>
    <div id="canvas-container"></div>

    <script>
        const videoElement = document.getElementById('input_video');
        const modeLabel = document.getElementById('mode-label');
        const statusBox = document.getElementById('status-box');
        const loadingScreen = document.getElementById('loading-screen');
        const glitchOverlay = document.getElementById('glitch-overlay');
        const handCanvas = document.getElementById('hand-overlay');
        const handCtx = handCanvas.getContext('2d');
        const container = document.getElementById('canvas-container');

        let scene, camera, renderer, points, geometry, material;
        const particleCount = 15000; // Maksimum stabillik üçün say daha da azaldıldı
        const positions = new Float32Array(particleCount * 3);
        const velocities = new Float32Array(particleCount * 3);
        const originalTarget = new Float32Array(particleCount * 3);

        let formationScale = 0;
        let isSymbioteMode = false;
        let isExploded = false;
        let handPos = new THREE.Vector3(0, 0, 0);

        function initThree() {
            try {
                // Kontekst yoxlanışı
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!gl) throw new Error("WebGL tapılmadı");

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
                
                renderer = new THREE.WebGLRenderer({ 
                    alpha: true,
                    antialias: false,
                    powerPreference: "high-performance",
                    precision: 'lowp',
                    depth: true,
                    stencil: false
                });
                
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(1); 
                container.appendChild(renderer.domElement);

                // Kontekst itkisi hadisəsi
                renderer.domElement.addEventListener('webglcontextlost', (event) => {
                    event.preventDefault();
                    console.warn('WebGL Konteksti itirildi. Yenidən yüklənir...');
                    location.reload();
                }, false);

                // Zərrəciklərin inisializasiyası
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    positions[i3] = (Math.random() - 0.5) * 150;
                    positions[i3+1] = (Math.random() - 0.5) * 150;
                    positions[i3+2] = (Math.random() - 0.5) * 150;
                    
                    const phi = Math.acos(-1 + (2 * i) / particleCount);
                    const theta = Math.sqrt(particleCount * Math.PI) * phi;
                    const r = 18;
                    originalTarget[i3] = r * Math.cos(theta) * Math.sin(phi);
                    originalTarget[i3+1] = r * Math.sin(theta) * Math.sin(phi);
                    originalTarget[i3+2] = r * Math.cos(phi);
                }

                geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                material = new THREE.PointsMaterial({
                    size: 0.35,
                    color: 0x00ffff,
                    transparent: true,
                    opacity: 0.7,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false
                });

                points = new THREE.Points(geometry, material);
                scene.add(points);

                camera.position.z = 50;
                return true;
            } catch (e) {
                loadingScreen.innerHTML = `
                    <div style="color: #ff3333; font-weight: bold;">SKANER XƏTASI</div>
                    <div style="font-size: 0.8rem; margin-top: 10px;">Sizin brauzeriniz qrafik resursları bloklayıb.</div>
                    <button class="error-btn" onclick="location.reload()">YENİDƏN BAŞLAT</button>
                    <div style="font-size: 0.6rem; margin-top: 15px; opacity: 0.5;">Texniki səbəb: WebGL Context Creation Failed</div>
                `;
                return false;
            }
        }

        function animate() {
            if (!renderer) return;
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;
            const currentPos = geometry.attributes.position.array;

            if (isSymbioteMode) {
                material.color.lerp(new THREE.Color(0xbc00ff), 0.1);
                glitchOverlay.style.display = 'block';
            } else {
                material.color.lerp(new THREE.Color(0x00ffff), 0.1);
                glitchOverlay.style.display = 'none';
            }

            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                if (isExploded) {
                    currentPos[i3] += velocities[i3];
                    currentPos[i3+1] += velocities[i3+1];
                    currentPos[i3+2] += velocities[i3+2];
                    velocities[i3] *= 0.95;
                    velocities[i3+1] *= 0.95;
                    velocities[i3+2] *= 0.95;
                } else {
                    let tx = originalTarget[i3] * formationScale;
                    let ty = originalTarget[i3+1] * formationScale;
                    let tz = originalTarget[i3+2] * formationScale;

                    if (isSymbioteMode) {
                        tx += Math.sin(time * 3 + i) * 1.5;
                        ty += Math.cos(time * 3 + i) * 1.5;
                    }

                    currentPos[i3] += (tx - currentPos[i3]) * 0.1;
                    currentPos[i3+1] += (ty - currentPos[i3+1]) * 0.1;
                    currentPos[i3+2] += (tz - currentPos[i3+2]) * 0.1;
                }
            }

            geometry.attributes.position.needsUpdate = true;

            if (formationScale > 0.05) {
                points.position.lerp(handPos, 0.1);
                points.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }

        function triggerExplosion() {
            isExploded = true;
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                velocities[i3] = (Math.random() - 0.5) * 1.5;
                velocities[i3+1] = (Math.random() - 0.5) * 1.5;
                velocities[i3+2] = (Math.random() - 0.5) * 1.5;
            }
        }

        function onResults(results) {
            if (loadingScreen.style.display !== 'none') loadingScreen.style.display = 'none';

            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
            handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const handsFound = results.multiHandLandmarks.length;
                const hand1 = results.multiHandLandmarks[0];
                drawConnectors(handCtx, hand1, HAND_CONNECTIONS, {color: isSymbioteMode ? '#bc00ff' : '#00ffff', lineWidth: 2});
                
                const wrist = hand1[0];
                const indexTip = hand1[8];
                const distance = Math.sqrt(Math.pow(indexTip.x - wrist.x, 2) + Math.pow(indexTip.y - wrist.y, 2));
                
                const isOpen = distance > 0.15;
                formationScale = THREE.MathUtils.lerp(formationScale, isOpen ? 1.2 : 0.1, 0.1);
                
                handPos.x = (0.5 - wrist.x) * 80;
                handPos.y = (0.5 - wrist.y) * 50;
                
                if (handsFound > 1) {
                    isSymbioteMode = true;
                    modeLabel.innerText = "SİMBİONT TƏHLÜKƏSİ!";
                    statusBox.classList.add('warning-mode');
                    
                    const hand2 = results.multiHandLandmarks[1];
                    const h2Wrist = hand2[0];
                    const h2Index = hand2[8];
                    const dist2 = Math.sqrt(Math.pow(h2Index.x - h2Wrist.x, 2) + Math.pow(h2Index.y - h2Wrist.y, 2));
                    
                    if (dist2 < 0.08) triggerExplosion();
                } else {
                    isSymbioteMode = false;
                    isExploded = false;
                    modeLabel.innerText = "STABİL NÜVƏ: AKTİV";
                    statusBox.classList.remove('warning-mode');
                }
            } else {
                formationScale = THREE.MathUtils.lerp(formationScale, 0, 0.05);
                modeLabel.innerText = "SKANER GÖZLƏNİLİR";
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);

        const cameraInstance = new Camera(videoElement, {
            onFrame: async () => {
                try {
                    await hands.send({ image: videoElement });
                } catch (e) {
                    console.error("Frame processing error:", e);
                }
            },
            width: 640, height: 480
        });

        window.onload = () => {
            // Bir az gözləyirik ki sistem özünə gəlsin
            setTimeout(() => {
                if (initThree()) {
                    cameraInstance.start().catch(err => {
                        loadingScreen.innerHTML = "Kamera icazəsi rədd edildi və ya cihaz tapılmadı.";
                    });
                    animate();
                }
            }, 500);
        };

        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
