<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistik Mavi Tüstü - Tək Əl</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #050505;
            font-family: sans-serif;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #videoElement, #outputCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Daha realistik duman üçün qatmanlı filtrasiya */
        #outputCanvas {
            filter: blur(4px) contrast(1.5) brightness(1.2) saturate(1.4);
            mix-blend-mode: screen;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00aaff;
            z-index: 10;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00aaff;
        }
    </style>
</head>
<body>

    <div id="loading">Kamera və Süni İntellekt hazırlanır...</div>

    <div class="container">
        <video id="videoElement" playsinline></video>
        <canvas id="outputCanvas"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        const canvasElement = document.getElementById('outputCanvas');
        const ctx = canvasElement.getContext('2d');
        const loadingDiv = document.getElementById('loading');

        let smokeParticles = [];

        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function isPointingIndex(landmarks) {
            // Şəhadət barmağı açıq, digərləri bağlı
            const isIndexOpen = landmarks[8].y < landmarks[6].y;
            const isMiddleClosed = landmarks[12].y > landmarks[10].y;
            const isRingClosed = landmarks[16].y > landmarks[14].y;
            const isPinkyClosed = landmarks[20].y > landmarks[18].y;
            return isIndexOpen && isMiddleClosed && isRingClosed && isPinkyClosed;
        }

        class SmokeParticle {
            constructor(x, y) {
                this.x = x + (Math.random() - 0.5) * 10;
                this.y = y;
                this.size = Math.random() * 20 + 15;
                this.maxSize = Math.random() * 80 + 100; // Tüstü yuxarı qalxdıqca genişlənir
                
                this.vx = (Math.random() - 0.5) * 1.5; // Üfüqi yayılma
                this.vy = (Math.random() * -3) - 2;   // Daha sürətli yuxarı qalxma
                
                this.alpha = 0.6; 
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.05;
                this.fadeSpeed = Math.random() * 0.005 + 0.004;
                this.turbulence = Math.random() * 0.05; // Tüstünün titrəməsi üçün
            }

            update() {
                this.x += this.vx + Math.sin(this.y * 0.05) * 0.5; // Sinusoidal hərəkət
                this.y += this.vy;
                
                this.size += 0.8; // Genişlənmə sürəti artırıldı
                this.alpha -= this.fadeSpeed;
                this.rotation += this.rotationSpeed;
                
                // Hava müqaviməti simulyasiyası
                this.vy *= 0.98;
                this.vx *= 0.99;
            }

            draw() {
                if (this.alpha <= 0) return;

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.globalAlpha = this.alpha;
                
                // Mərkəzi parlaq, kənarları dumanlı gradient
                const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, this.size);
                grad.addColorStop(0, 'rgba(0, 180, 255, 0.6)');  // İntensiv mavi mərkəz
                grad.addColorStop(0.3, 'rgba(0, 100, 200, 0.3)'); // Keçid
                grad.addColorStop(0.7, 'rgba(50, 50, 150, 0.1)'); // Dumanlı kənar
                grad.addColorStop(1, 'transparent');

                ctx.fillStyle = grad;
                
                // Tüstü forması üçün bir az qeyri-müntəzəm dairə (scale ilə)
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
        }

        function onResults(results) {
            if (loadingDiv) loadingDiv.style.display = 'none';
            
            ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Tüstülərin bir-birinin üstünə minərək parlaqlıq yaratması üçün
            ctx.globalCompositeOperation = 'screen'; 

            // Yalnız 1-ci əli götürürük (hətta kamerada 2 əl olsa belə)
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0]; 
                
                if (isPointingIndex(landmarks)) {
                    const tip = landmarks[8];
                    // Normalizə olunmuş koordinatları pikselə çeviririk
                    const x = tip.x * canvasElement.width;
                    const y = tip.y * canvasElement.height;
                    
                    // Daha qatı tüstü üçün hər frame-də 5 hissəcik
                    for(let i=0; i<5; i++) {
                        smokeParticles.push(new SmokeParticle(x, y));
                    }
                }
            }

            // Hissəcikləri emal et
            for (let i = 0; i < smokeParticles.length; i++) {
                smokeParticles[i].update();
                smokeParticles[i].draw();
                if (smokeParticles[i].alpha <= 0 || smokeParticles[i].size > 300) {
                    smokeParticles.splice(i, 1);
                    i--;
                }
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1, // MediaPipe-a yalnız 1 əl axtarmağı tapşırırıq
            modelComplexity: 1,
            minDetectionConfidence: 0.8,
            minTrackingConfidence: 0.8
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        camera.start().catch(err => {
            loadingDiv.innerText = "Kameraya giriş rədd edildi və ya xəta baş verdi.";
            console.error(err);
        });
    </script>
</body>
</html>
