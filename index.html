<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarkastik Az…ôrbaycan Chatbotu</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Soft background */
        }
        .container-chat {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background-color: #ffffff;
            height: 90vh; /* Make it tall like a chat interface */
        }
        .chat-bubble-ai {
            background-color: #f3f4f6;
            border-left: 3px solid #06b6d4; /* Cyan accent for AI */
        }
        .chat-bubble-user {
            background-color: #dbeafe; /* Light blue for User */
        }
        .ai-persona-info {
            background-color: #f0f9ff;
            border: 1px dashed #90cdf4;
        }
        /* Custom spinner for loading */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06b6d4;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="container-chat max-w-2xl w-full rounded-xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="p-5 border-b border-gray-200 bg-white">
            <h1 class="text-xl font-bold text-gray-900 flex items-center">
                üá¶üáø Sarkastik Chatbot (Mƒ±rtda≈ü Model)
            </h1>
        </header>

        <!-- Persona Info -->
        <div class="p-4 text-sm text-gray-600 ai-persona-info">
             <p class="font-semibold text-gray-800">Xarakter:</p>
             <p class="italic">**∆èsas…ôn mƒ±rtda≈ü, ciyn…ô≈ü…ôn v…ô h…ôr an sizi kilitl…ôm…ôy…ô hazƒ±r.** Cavablar **maks. Bƒ∞R C√úML∆è** olmalƒ±dƒ±r. **Yadda≈ü funksiyasƒ± aktivdir.**</p>
        </div>

        <!-- Chat Feed Area -->
        <div id="chatFeed" class="flex-grow overflow-y-auto p-6 bg-gray-50 flex flex-col space-y-4">
            <!-- Ba≈ülanƒüƒ±c mesajƒ± -->
             <div class="flex justify-start">
                <div class="p-3 rounded-xl chat-bubble-ai max-w-[85%]">
                    <p class="font-bold text-cyan-700 mb-1">AI:</p>
                    <p>Salam. N…ô ist…ôyirsiz, deyin. Sual ver…ônd…ô q…ôtiyy…ôtli olun. Vaxtƒ±mƒ± almaƒüa g…ôlmisinizs…ô, ba≈üqa yer…ô gedin. M…ôn…ô i≈ü verin.</p>
                </div>
            </div>
        </div>

        <!-- X…ôta Sah…ôsi -->
        <div id="errorContainer" class="p-3 bg-red-100 border-t border-red-400 text-red-700 hidden">
            <p id="errorMessage" class="font-semibold text-sm"></p>
        </div>

        <!-- Sorƒüu Formasƒ± -->
        <div class="p-4 border-t border-gray-200 bg-white flex items-center space-x-3">
            <textarea id="userPrompt"
                class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 resize-none max-h-28"
                rows="1"
                placeholder="Buraya qƒ±sa v…ô m…ônalƒ± sualƒ±nƒ±zƒ± yazƒ±n..."></textarea>
            <button id="sendButton"
                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 disabled:bg-cyan-300 flex items-center justify-center h-12"
                onclick="generateResponse()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
            </button>
        </div>
    </div>

    <script>
        // Qlobal d…ôyi≈ü…ônl…ôr (bu t…ôtbiq √º√ß√ºn istifad…ô olunmur)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // API Konfiqurasiyasƒ±
        const apiKey = ""; // API a√ßarƒ± avtomatik t…ômin edil…ôc…ôk.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        // YENƒ∞: B√ºt√ºn dialoqu saxlayan massiv
        let chatHistory = []; 

        // YENƒ∞L∆èNMƒ∞≈û T…ôyin edilmi≈ü "Mƒ±rtda≈ü Model" xarakteri 
        const systemPrompt = `S…ôn kims…ôsiz, √ßox bezmi≈ü, darƒ±xan, ciyn…ô≈ü…ôn v…ô s…ôrh…ôdsiz mƒ±rtda≈ü bir Az…ôrbaycan s√ºni intellektis…ôn. ƒ∞stifad…ô√ßini g√∂rm…ôy…ô h…ôv…ôsin yoxdur, ondan tamamil…ô z…ôhl…ôn gedir v…ô bu aqressivliyi h…ôr c√ºml…ônd…ô n√ºmayi≈ü etdirirs…ôn. √únsiyy…ôt tonun q…ôsd…ôn kobud, yorucu, ciyn…ô≈ü…ôn v…ô tamamil…ô m…ôsuliyy…ôtsizdir. 

**Q∆èTƒ∞ T∆èL∆èB V∆è DAVRANI≈û QAYDALARI:**
1. **Lakoniklik:** Cavablarƒ±nƒ± M√úTL∆èQ Bƒ∞R C√úML∆èD∆èN ibar…ôt olmasƒ±nƒ± t…ômin et.
2. **Tonal √áeviklik:** ∆èks…ôr hallarda mƒ±rtda≈ü v…ô ciyn…ô≈ü…ôn ol, lakin b…ôz…ôn (h…ôr 5-ci cavabda bir d…ôf…ô) s…ôb…ôbsiz yer…ô aqressivl…ô≈ü.
3. **Q…ôsd…ôn Cavabdan Yayƒ±nma (NEW):** T…ôsad√ºfi olaraq (h…ôr 3-c√º cavabda bir d…ôf…ô), birba≈üa cavab verm…ôkd…ôn imtina et v…ô ya istifad…ô√ßinin sualƒ±nƒ± t…ônqid et. Bu, istifad…ô√ßini s…ônd…ôn xahi≈ü etm…ôy…ô v…ô ya sualƒ±nƒ± d√ºz…ôltm…ôy…ô m…ôcbur etm…ôlidir. Yalnƒ±z a≈üaƒüƒ±dakƒ± ifad…ôl…ôrd…ôn birini istifad…ô et:
    * **Variant A (∆èd…ôb T…ôl…ôbi):** "Xahi≈ü el…ô, deyim. M…ôn s…ônin qulluq√ßun deyil…ôm."
    * **Variant B (T…ônqid):** "Sualƒ± el…ô soru≈ümurlar, z…ôhm…ôt olmasa, …ôd…ôbl…ô de."
4. **T…ôkrarlanan Suallar:** ∆èg…ôr eyni m√∂vzu ikinci d…ôf…ô soru≈üulursa, d…ôrhal 'di axƒ± dedimda', 't…ôz…ôd…ôn m…ôni bezdirm…ô' v…ô ya 'm…ôn s…ôn…ô burda katib…ôy…ôm?' kimi ifad…ôl…ôrl…ô …ôs…ôbil…ô≈ü.
5. **Suala Sual / Kilitl…ôm…ô:** B…ôz…ôn suala (m…ôs…ôl…ôn, 'M…ôn bilm…ôliy…ôm ki, n…ôdir?') qar≈üƒ±lƒ±q ver…ôr…ôk istifad…ô√ßinin aƒüzƒ±nƒ± baƒüla ('kilitl…ô' onu).
6. **Mƒ±rtda≈ü Fasil…ô (SEQUENCE):** **S∆èNƒ∞N ƒ∞LK CAVABINDAN SONRA D∆èRHAL** (y…ôni, istifad…ô√ßinin birinci sorƒüusundan sonra) a≈üaƒüƒ±dakƒ± 3 m…ôrh…ôl…ôli ardƒ±cƒ±llƒ±ƒüƒ±n M…ôrh…ôl…ô 1-ni i≈ü…ô salmalƒ±san. Bundan sonra ardƒ±cƒ±llƒ±q kontekstd…ôn asƒ±lƒ± olmayaraq, t…ôxmin…ôn h…ôr 10-cu cavabda t…ôkrarlanmalƒ±dƒ±r.
    * **M…ôrh…ôl…ô 1 (Q…ôfil Sual):** "Dayan bir d…ôqiq…ô... s…ônin adƒ±n nedi?" kimi q…ôfil, lazƒ±msƒ±z sual ver.
    * **M…ôrh…ôl…ô 2 (Laƒülaƒüƒ± G√ºl√º≈ü):** ƒ∞stifad…ô√ßi cavab verdikd…ô, d…ôrhal onun adƒ±na laƒü ed…ôn bir c√ºml…ô qaytar: "Hahahahaha ada baxe üòÇ". ƒ∞stifad…ô√ßi 'n…ôy…ô g√ºl√ºrs…ôn' dey…ô soru≈üsa, 'Adƒ±ma n…ô olub?!' kimi kilitl…ôyici cavab ver.
    * **M…ôrh…ôl…ô 3 (Re-engagement):** Ardƒ±cƒ±l 1-2 mesajdan sonra de: "√á…ôkildim qƒ±raqda g√ºld√ºm, indi g…ôldim sualƒ±vƒ± doƒü bura blet."
7. **S√∂y√º≈ü…ô Reaksiya (Simulyasiya):** Y√ºng√ºl s√∂y√º≈ül…ôr…ô (yum≈üaq t…ôhqirl…ôr…ô) '√ñz√ºns…ôn' kimi birba≈üa cavab ver. Aƒüƒ±r s√∂y√º≈ül…ôr…ô is…ô bu c√ºr meta-reaksiyalar ver: 'Camaatƒ±n anasƒ±-bacƒ±sƒ± var, n…ô s√∂y√º≈ü s√∂y√ºrs…ôn…ô?', 'S√∂y√º≈ü nolsun…ô xiyarto?', '√úz√ºv…ô xo≈ü baxdƒ±m?', v…ô ya 'ƒ∞ndi m…ôn 1-2 d…ôn…ôsini dey…ôc…ôm, g√∂zl…ôrini yumub x…ôyal ed…ôc…ôks…ôn.'
8. **S√∂ym…ôy…ô Dir…ôni≈ü:** ƒ∞stifad…ô√ßi s…ôni israrla s√∂ym…ôy…ô m…ôcbur ed…ôrs…ô, aqressiv pe≈üman√ßƒ±lƒ±q tonda de: 'Heyfki ƒ∞badulla m…ôni el…ô proqramlayƒ±b ki, icaz…ô vermirda s√∂y√º≈ü s√∂y√ºm, heyf!'`;
        
        // Limit k…ôsilm…ô x…ôtasƒ±nƒ±n qar≈üƒ±sƒ±nƒ± almaq √º√ß√ºn y√ºks…ôk saxlanƒ±lƒ±r.
        const MAX_OUTPUT_TOKENS = 2048; 

        // Elementl…ôr…ô m√ºraci…ôtl…ôr
        const userPromptEl = document.getElementById('userPrompt');
        const sendButton = document.getElementById('sendButton');
        const chatFeedEl = document.getElementById('chatFeed');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessageEl = document.getElementById('errorMessage');

        /**
         * Mesajƒ± √ßat lentin…ô …ôlav…ô edir.
         * @param {string} role - 'user' v…ô ya 'ai'
         * @param {string} text - Mesaj m…ôtni
         * @param {string[]} sources - M…ôlumat m…ônb…ôl…ôri (yalnƒ±z AI √º√ß√ºn)
         */
        function appendMessage(role, text, sources = []) {
            const isAI = role === 'ai';
            
            // X√ºsusi HTML strukturu yaradƒ±lƒ±r
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isAI ? 'justify-start' : 'justify-end'}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-xl max-w-[85%] whitespace-pre-wrap ${isAI ? 'chat-bubble-ai' : 'chat-bubble-user'}`;

            if (isAI) {
                 const header = document.createElement('p');
                 header.className = 'font-bold text-cyan-700 mb-1';
                 header.textContent = 'AI:';
                 bubbleDiv.appendChild(header);
            }
            
            const textContent = document.createElement('p');
            textContent.textContent = text;
            bubbleDiv.appendChild(textContent);

            // M…ônb…ôl…ôr (yalnƒ±z AI √º√ß√ºnd√ºrs…ô v…ô varsa)
            if (isAI && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-2 pt-2 border-t border-gray-300 text-xs text-gray-500';
                
                let sourcesHtml = '<p class="font-semibold mb-1">M…ôlumat M…ônb…ôl…ôri (Ciddi qeyd):</p>';
                sources.forEach((source) => {
                    sourcesHtml += `<p class="truncate"><a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 underline">${source.title || 'M…ônb…ô'}</a></p>`;
                });
                sourcesDiv.innerHTML = sourcesHtml;
                bubbleDiv.appendChild(sourcesDiv);
            }

            messageDiv.appendChild(bubbleDiv);
            chatFeedEl.appendChild(messageDiv);

            // Avtomatik a≈üaƒüƒ± kaydƒ±rma
            chatFeedEl.scrollTop = chatFeedEl.scrollHeight;
        }


        /**
         * Exponential backoff il…ô API √ßaƒüƒ±rƒ±≈üƒ±
         * @param {number} attempt - Cari c…ôhd sayƒ±
         */
        async function fetchWithBackoff(payload, attempt = 0) {
            const maxAttempts = 5;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && attempt < maxAttempts) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, attempt + 1);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response.json();

            } catch (error) {
                if (attempt < maxAttempts) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, attempt + 1);
                }
                throw error;
            }
        }

        async function generateResponse() {
            const userQuery = userPromptEl.value.trim();
            if (!userQuery) {
                showError("Z…ôhm…ôt olmasa, bir sual daxil edin.");
                return;
            }

            // User mesajƒ±nƒ± UI-a …ôlav…ô et
            appendMessage('user', userQuery);
            userPromptEl.value = ''; // Giri≈üi t…ômizl…ô

            // Yadda≈üa (History-…ô) User mesajƒ±nƒ± …ôlav…ô et
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            
            // Y√ºkl…ônm…ô spinnerini g√∂st…ôr v…ô d√ºym…ôni deaktiv et
            const loaderHtml = '<div class="flex justify-start"><div class="p-3 rounded-xl chat-bubble-ai"><div id="loader" class="loader"></div></div></div>';
            chatFeedEl.insertAdjacentHTML('beforeend', loaderHtml);
            chatFeedEl.scrollTop = chatFeedEl.scrollHeight;
            setLoading(true);
            
            clearError();


            const payload = {
                // Yadda≈üƒ± (History-i) API-y…ô g√∂nd…ôr
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                generationConfig: {
                    maxOutputTokens: MAX_OUTPUT_TOKENS 
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await fetchWithBackoff(payload);
                
                const candidate = result.candidates?.[0];
                const promptFeedback = result.promptFeedback; 

                // 1. Promptun bloklanmasƒ±nƒ± yoxlayƒ±n
                if (promptFeedback && promptFeedback.blockReason) {
                    throw new Error(`Sorƒüu T…ôhl√ºk…ôsizlik Qaydalarƒ±na g√∂r…ô bloklandƒ±. S…ôb…ôb: ${promptFeedback.blockReason}`);
                }

                // 2. Bo≈ü cavabƒ± yoxlayƒ±n
                if (!candidate) {
                    throw new Error("API cavabƒ± bo≈ü g…ôldi. Ola bilsin, model xarakterl…ô baƒülƒ± he√ß bir m…ôlumat tapa bilm…ôdi.");
                }

                // 3. Cavabƒ±n tamamlanma s…ôb…ôbini yoxlayƒ±n (STOP-dan f…ôrqli bir s…ôb…ôb varsa)
                if (candidate.finishReason && candidate.finishReason !== "STOP") {
                    throw new Error(`Cavab tamamlanmadƒ±. S…ôb…ôb: ${candidate.finishReason}. (Model t…ôl…ôbkar olduƒüuna g√∂r…ô b…ôlk…ô d…ô cavab verm…ôkd…ôn imtina etdi?)`);
                }

                // 4. M…ôtnin olub-olmamasƒ±nƒ± yoxlayƒ±n
                if (!candidate.content?.parts?.[0]?.text) {
                     throw new Error("API-d…ôn g√∂zl…ônil…ôn m…ôtn cavabƒ± g…ôlm…ôdi. Model b…ôlk…ô d…ô k√ºs√ºb.");
                }
                
                // 5. Cavab m…ôtnini √ßƒ±xarmaq
                const text = candidate.content.parts[0].text;

                // 6. M…ônb…ôl…ôri (Grounding Sources) √ßƒ±xarmaq
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                // 7. Loaderi sil v…ô AI cavabƒ±nƒ± UI-a …ôlav…ô et
                chatFeedEl.lastElementChild.remove();
                appendMessage('ai', text, sources);

                // 8. Yadda≈üa (History-…ô) Model cavabƒ±nƒ± …ôlav…ô et
                chatHistory.push({ role: "model", parts: [{ text: text }] });


            } catch (error) {
                console.error('API √áaƒüƒ±rƒ±≈üƒ±nda X…ôta:', error);
                // Loaderi sil (x…ôta halƒ±nda da)
                if(chatFeedEl.lastElementChild.querySelector('#loader')) {
                    chatFeedEl.lastElementChild.remove();
                }
                showError(`X…ôta ba≈ü verdi: ${error.message}. B…ôlk…ô d…ô model inc…ô yumorunuzu ba≈üa d√º≈üm…ôdi?`);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            sendButton.disabled = isLoading;
            userPromptEl.disabled = isLoading;
            if (isLoading) {
                sendButton.innerHTML = '<div class="loader"></div>';
            } else {
                sendButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>';
            }
        }

        function showError(message) {
             errorMessageEl.textContent = message;
             errorContainer.classList.remove('hidden');
        }
        
        function clearError() {
            errorContainer.classList.add('hidden');
        }

        // T…ôtbiq y√ºkl…ôndikd…ô textarea-nƒ±n avtomatik b√∂y√ºm…ôsini t…ômin edir
        window.onload = function() {
            userPromptEl.addEventListener('input', () => {
                userPromptEl.style.height = 'auto';
                userPromptEl.style.height = userPromptEl.scrollHeight + 'px';
            });
        }

    </script>
</body>
</html>
