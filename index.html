import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, limit, orderBy, onSnapshot, getDocs, startAfter, endBefore, limitToLast, where } from 'firebase/firestore';
import { Copy, X, Loader, ChevronLeft, ChevronRight, LayoutGrid } from 'lucide-react';

// --- Firebase Konfiqurasiyası və İlkin Quruluş ---
// Global dəyişənləri yoxla və təyin et
const appId = typeof __app_id !== 'undefined' ? __app_id : 'axtargetui-default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

let app;
let db;
let auth;
let firebaseInitSuccess = false;

try {
  if (Object.keys(firebaseConfig).length > 0) {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    firebaseInitSuccess = true; // Əgər konfiqurasiya uğurludursa
  } else {
    console.error("Firebase konfiqurasiyası tapılmadı.");
  }
} catch (error) {
  console.error("Firebase tətbiqini işə salarkən xəta baş verdi:", error);
}

// Firestore yolu (ictimai məlumatlar üçün)
const getCollectionPath = () => `/artifacts/${appId}/public/data/ui_components`;

// Səhifələmə üçün element sayı
const ITEMS_PER_PAGE = 12;

// --- Utility Funksiyaları ---

/**
 * Kodu panoya kopyalayır.
 * @param {string} text Kopyalanacaq mətn.
 * @returns {Promise<boolean>} Kopyalama uğurlu olub-olmaması.
 */
const copyToClipboard = async (text) => {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      return true;
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = 0;
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textarea);
      return success;
    }
  } catch (err) {
    console.error('Kopyalama uğursuz oldu: ', err);
    return false;
  }
};

// --- Komponentlər ---

/**
 * Yüklənmə animasiyası.
 */
const LoadingScreen = () => (
  <div className="fixed inset-0 bg-gray-900/90 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
    <Loader className="w-12 h-12 text-teal-400 animate-spin" />
    <p className="mt-4 text-xl font-medium text-gray-200">
      AxtarGetUI yüklənir...
    </p>
  </div>
);

/**
 * Əsas səhifədəki hər bir UI elementini təmsil edən kart.
 */
const ComponentCard = React.memo(({ component, onClick }) => {
  // Kart üzərindəki kiçik önizləmə üçün iframe
  const iframeContent = useMemo(() => `
    <!DOCTYPE html>
    <html lang="az">
    <head>
        <style>
            body { margin: 0; padding: 1rem; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #0d1117; overflow: hidden; }
            ${component.css}
        </style>
    </head>
    <body>
        ${component.html}
    </body>
    </html>
  `, [component.html, component.css]);

  return (
    <div
      onClick={() => onClick(component)}
      className="bg-gray-800 rounded-xl shadow-lg hover:shadow-teal-500/50 transition duration-300 cursor-pointer overflow-hidden transform hover:scale-[1.02] border border-gray-700 hover:border-teal-500"
    >
      <div className="p-4">
        <h3 className="text-lg font-semibold text-gray-100 truncate">{component.title}</h3>
        <p className="text-sm text-teal-400 mt-1">{component.category}</p>
      </div>
      <div className="h-48 w-full bg-[#0d1117] flex items-center justify-center border-t border-gray-700">
        <iframe
          title={`Önizləmə: ${component.title}`}
          srcDoc={iframeContent}
          className="w-full h-full border-none pointer-events-none"
          sandbox="allow-scripts"
        />
      </div>
    </div>
  );
});

/**
 * Seçilmiş UI elementinin detallı görünüşü (önizləmə + kod).
 */
const DetailView = ({ component, onClose }) => {
  const [copied, setCopied] = useState(false);

  const fullCode = useMemo(() => `
<!-- ${component.title} - HTML -->
${component.html}

/* ${component.title} - CSS */
${component.css}
`, [component.html, component.css, component.title]);

  const handleCopy = useCallback(async () => {
    const success = await copyToClipboard(fullCode);
    if (success) {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  }, [fullCode]);

  const iframeContent = useMemo(() => `
    <!DOCTYPE html>
    <html lang="az">
    <head>
        <style>
            body { margin: 0; padding: 2rem; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #0d1117; }
            ${component.css}
        </style>
    </head>
    <body>
        ${component.html}
    </body>
    </html>
  `, [component.html, component.css]);

  return (
    <div className="fixed inset-0 bg-gray-900/95 backdrop-blur-sm z-40 flex overflow-hidden">
      <div className="absolute top-4 right-4 z-50">
        <button
          onClick={onClose}
          className="p-3 bg-gray-800 text-white rounded-full shadow-lg hover:bg-red-600 transition duration-200"
          title="Bağla"
        >
          <X className="w-6 h-6" />
        </button>
      </div>

      <div className="flex w-full h-full p-4 md:p-8">
        {/* Sol tərəf: Kod Editör/Kopyalama */}
        <div className="w-full md:w-1/2 p-2 md:p-4 flex flex-col h-full">
          <h2 className="text-2xl font-bold text-gray-100 mb-4">{component.title} Kodu</h2>
          <div className="flex-1 overflow-hidden relative rounded-xl shadow-xl border border-gray-700">
            <pre className="bg-gray-800 text-sm p-4 text-gray-300 overflow-auto h-full whitespace-pre-wrap break-words scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">
              {fullCode}
            </pre>
            <button
              onClick={handleCopy}
              className={`absolute top-4 right-4 px-4 py-2 rounded-lg text-sm font-medium transition duration-300 flex items-center ${
                copied
                  ? 'bg-green-600 text-white'
                  : 'bg-teal-600 text-white hover:bg-teal-500'
              }`}
            >
              <Copy className="w-4 h-4 mr-2" />
              {copied ? 'Kopyalandı!' : 'Kodu Kopyala'}
            </button>
          </div>
        </div>

        {/* Sağ tərəf: Önizləmə (Ayrı Səhifə Effekti) */}
        <div className="hidden md:flex md:w-1/2 p-2 md:p-4 flex-col h-full">
          <h2 className="text-2xl font-bold text-gray-100 mb-4">Canlı Önizləmə</h2>
          <div className="flex-1 rounded-xl shadow-xl overflow-hidden border border-gray-700 bg-[#0d1117]">
            <iframe
              title={`Tam Önizləmə: ${component.title}`}
              srcDoc={iframeContent}
              className="w-full h-full border-none"
              sandbox="allow-scripts"
            />
          </div>
        </div>
      </div>
    </div>
  );
};

/**
 * Əsas tətbiq komponenti
 */
const App = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [userId, setUserId] = useState(null);
  const [isAppLoading, setIsAppLoading] = useState(true); // Ümumi yüklənmə statusu
  const [isFirebaseReady, setIsFirebaseReady] = useState(firebaseInitSuccess); // NEW: Global init check
  const [components, setComponents] = useState([]);
  const [categories, setCategories] = useState([]);
  const [selectedCategory, setSelectedCategory] = useState('Hamısı');
  const [selectedComponent, setSelectedComponent] = useState(null);

  // Pagination state
  const [currentPage, setCurrentPage] = useState(1);
  const [firstVisible, setFirstVisible] = useState(null);
  const [lastVisible, setLastVisible] = useState(null);
  const [pageHistory, setPageHistory] = useState([null]);
  const [hasMorePages, setHasMorePages] = useState(false);

  // --- Auth və Firebase İlkin Quruluş ---
  useEffect(() => {
    // Əgər global init uğursuz olubsa, auth prosesini başlatma.
    if (!isFirebaseReady) {
        setIsAppLoading(false);
        return;
    }

    // Auth prosesini başlat
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        setIsAuthenticated(true);
        setUserId(user.uid);
      } else {
        // Anonim daxil olmaq
        try {
          const credentials = initialAuthToken
            ? await signInWithCustomToken(auth, initialAuthToken)
            : await signInAnonymously(auth);
            
          setIsAuthenticated(true);
          setUserId(credentials.user.uid);
        } catch (error) {
          console.error("Firebase Auth Xətası:", error);
          // Auth səhvi olduqda, yüklənməni bitirib autentifikasiyanı false et.
          setIsAuthenticated(false);
          setIsAppLoading(false); 
        }
      }
    });

    return () => unsubscribe();
  }, [isFirebaseReady]); // isFirebaseReady-dən asılıdır

  // --- Məlumatların Yüklənməsi (Pagination və Filter) ---
  const fetchData = useCallback(async () => {
    // Yalnız autentifikasiya uğurlu olduqda və DB mövcud olduqda davam et.
    if (!isAuthenticated || !db || !isFirebaseReady) return;

    setIsAppLoading(true);

    const componentsColRef = collection(db, getCollectionPath());
    let q = query(componentsColRef, orderBy('createdAt', 'desc'));

    // Filter tətbiqi
    if (selectedCategory !== 'Hamısı') {
      q = query(q, where('category', '==', selectedCategory));
    }

    // Pagination (Cari Səhifəyə uyğun limit və startAfter)
    const currentCursor = pageHistory[currentPage - 1];

    if (currentCursor) {
        q = query(q, startAfter(currentCursor), limit(ITEMS_PER_PAGE));
    } else {
        // İlk səhifə
        q = query(q, limit(ITEMS_PER_PAGE));
    }


    try {
      const unsubscribe = onSnapshot(q, async (snapshot) => {
        const componentList = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
        }));

        setComponents(componentList);

        if (componentList.length > 0) {
            setFirstVisible(snapshot.docs[0]);
            setLastVisible(snapshot.docs[snapshot.docs.length - 1]);
        } else {
             setFirstVisible(null);
             setLastVisible(null);
        }

        // Bütün kateqoriyaları çıxarmaq
        // Bu hissə auth-dan sonra yalnız bir dəfə və ya ehtiyac olduqda yenilənməlidir.
        if (categories.length <= 1) { // Yalnız Hamısı varsa, bütün kateqoriyaları gətir
             const allDocsQuery = query(collection(db, getCollectionPath()));
             const allDocsSnapshot = await getDocs(allDocsQuery);
             const allCategories = new Set(['Hamısı']);
             allDocsSnapshot.forEach(doc => {
                 const data = doc.data();
                 if (data.category) {
                     allCategories.add(data.category);
                 }
             });
             setCategories(Array.from(allCategories));
        }


        // Daha çox səhifə olub olmadığını yoxlamaq (Növbəti düyməsi üçün)
        if (componentList.length === ITEMS_PER_PAGE) {
            const nextQuery = query(
                componentsColRef,
                orderBy('createdAt', 'desc'),
                startAfter(snapshot.docs[snapshot.docs.length - 1]),
                limit(1)
            );
            const nextSnapshot = await getDocs(nextQuery);
            setHasMorePages(nextSnapshot.docs.length > 0);
        } else {
            setHasMorePages(false);
        }

        setIsAppLoading(false);
      }, (error) => {
        console.error("Firestore-dan məlumat alınarkən xəta:", error);
        setIsAppLoading(false);
      });

      return () => unsubscribe();

    } catch (error) {
      console.error("Məlumat gətirilərkən xəta:", error);
      setIsAppLoading(false);
    }
  }, [isAuthenticated, isFirebaseReady, selectedCategory, currentPage, pageHistory]); // eslint-disable-line react-hooks/exhaustive-deps


  // useEffect yenidən yüklənməni idarə edir
  useEffect(() => {
    if (isAuthenticated && isFirebaseReady) {
      fetchData();
    }
  }, [isAuthenticated, isFirebaseReady, selectedCategory, currentPage]); // eslint-disable-line react-hooks/exhaustive-deps


  // --- Səhifələmə Hissəsi ---

  const handleNextPage = () => {
    if (lastVisible && hasMorePages) {
      const nextPage = currentPage + 1;
      setPageHistory(prev => {
        if (prev.length < nextPage) {
          return [...prev, lastVisible];
        }
        return prev;
      });
      setCurrentPage(nextPage);
      window.scrollTo(0, 0);
    }
  };

  const handlePrevPage = () => {
    if (currentPage > 1) {
      const prevPage = currentPage - 1;
      setCurrentPage(prevPage);
      window.scrollTo(0, 0);
    }
  };

  const handlePageChange = (page) => {
    if (page >= 1 && page <= pageHistory.length) {
      setCurrentPage(page);
      window.scrollTo(0, 0);
    }
  }

  // --- Render Funksiyaları ---

  // RENDER QORUYUCUSU 1: Əgər Firebase heç işə salınmayıbsa (Global error)
  if (!isFirebaseReady && !isAppLoading) {
    return (
        <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center p-4">
            <div className="text-center bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-500">
                <p className="text-red-400 text-2xl font-bold mb-4">❌ Tətbiq Xətası</p>
                <p className="text-lg text-gray-300">Firebase xidmətləri işə salına bilmədi.</p>
                <p className="text-sm text-gray-400 mt-2">
                  Bu, adətən yanlış konfiqurasiya ilə bağlıdır. Zəhmət olmasa kodun başlanğıcındakı 
                  konfiqurasiya hissəsini yoxlayın.
                </p>
            </div>
        </div>
    );
  }


  return (
    <div className="min-h-screen bg-gray-900 text-white font-sans">
      {(isAppLoading && !selectedComponent) && <LoadingScreen />}

      {/* Başlıq və Filter Hissəsi */}
      <header className="bg-gray-800 shadow-md sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center">
          <h1 className="text-3xl font-extrabold text-teal-400 mb-4 md:mb-0">
            AxtarGetUI <span className="text-gray-400 text-sm font-medium">| Kod Kitabxanası</span>
          </h1>

          <nav className="flex flex-wrap gap-2 justify-center">
            {categories.map(category => (
              <button
                key={category}
                onClick={() => {
                  setSelectedCategory(category);
                  setCurrentPage(1);
                  setPageHistory([null]); // Sıfırla
                }}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition duration-200 ${
                  selectedCategory === category
                    ? 'bg-teal-600 text-white shadow-teal-500/50 shadow-md'
                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`}
              >
                {category}
              </button>
            ))}
          </nav>
        </div>
      </header>

      {/* Əsas Kontent */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 className="text-2xl font-semibold mb-6 text-gray-200 flex items-center">
          <LayoutGrid className="w-6 h-6 mr-2 text-teal-400" />
          {selectedCategory === 'Hamısı' ? 'Bütün Kod Snippetləri' : `${selectedCategory} Snippetləri`}
        </h2>

        {components.length === 0 && !isAppLoading ? (
          <div className="text-center py-20 bg-gray-800 rounded-xl border border-gray-700">
            <p className="text-xl text-gray-400">Bu kateqoriyada heç bir element tapılmadı.</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {components.map((comp) => (
              <ComponentCard
                key={comp.id}
                component={comp}
                onClick={setSelectedComponent}
              />
            ))}
          </div>
        )}

        {/* Səhifələmə */}
        {(components.length > 0 || currentPage > 1) && (
          <div className="flex justify-center items-center mt-12 space-x-4">
            {/* Əvvəlki düyməsi */}
            <button
              onClick={handlePrevPage}
              disabled={currentPage === 1 || isAppLoading}
              className="p-3 bg-gray-800 rounded-full hover:bg-teal-600 disabled:opacity-50 transition duration-200"
            >
              <ChevronLeft className="w-5 h-5 text-white" />
            </button>

            {/* Səhifə nömrələri (sadələşdirilmiş) */}
            <div className="flex space-x-2">
              {[...Array(pageHistory.length)].map((_, index) => (
                <button
                  key={index}
                  onClick={() => handlePageChange(index + 1)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition duration-200 ${
                    currentPage === index + 1
                      ? 'bg-teal-600 text-white'
                      : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                  }`}
                >
                  {index + 1}
                </button>
              ))}

              {/* Növbəti səhifə kursoru yaradılmayıbsa, lakin daha çox səhifə varsa ... göstər */}
              {hasMorePages && (
                  <button
                    onClick={handleNextPage}
                    className="px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-300 hover:bg-gray-600"
                  >
                    {pageHistory.length + 1}
                  </button>
              )}
            </div>

            {/* Sonrakı düyməsi */}
            <button
              onClick={handleNextPage}
              disabled={!hasMorePages || isAppLoading}
              className="p-3 bg-gray-800 rounded-full hover:bg-teal-600 disabled:opacity-50 transition duration-200"
            >
              <ChevronRight className="w-5 h-5 text-white" />
            </button>
          </div>
        )}
      </main>

      {/* Detallı Görünüş Modal/Overlay */}
      {selectedComponent && (
        <DetailView
          component={selectedComponent}
          onClose={() => setSelectedComponent(null)}
        />
      )}
      
      {/* Footer - Anonim ID-nin Göstərilməsi */}
      <footer className="bg-gray-800/50 mt-10 py-4 border-t border-gray-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-400">
          {userId ? (
            <p>Sizin Cari İstifadəçi ID-niz (Anonim): <span className="font-mono text-teal-400 select-all break-all">{userId}</span></p>
          ) : (
            <p>Kimlik yoxlanılır...</p>
          )}
        </div>
      </footer>
    </div>
  );
};

export default App;
