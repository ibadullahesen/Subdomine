<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarkastik Azərbaycan Chatbotu</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Soft background */
        }
        .container-chat {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background-color: #ffffff;
            height: 90vh; /* Make it tall like a chat interface */
        }
        .chat-bubble-ai {
            background-color: #f3f4f6;
            border-left: 3px solid #06b6d4; /* Cyan accent for AI */
        }
        .chat-bubble-user {
            background-color: #dbeafe; /* Light blue for User */
        }
        .ai-persona-info {
            background-color: #f0f9ff;
            border: 1px dashed #90cdf4;
        }
        /* Custom spinner for loading */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06b6d4;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="container-chat max-w-2xl w-full rounded-xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="p-5 border-b border-gray-200 bg-white">
            <h1 class="text-xl font-bold text-gray-900 flex items-center">
                🇦🇿 Sarkastik Chatbot (Mırtdaş Model)
            </h1>
        </header>

        <!-- Persona Info -->
        <div class="p-4 text-sm text-gray-600 ai-persona-info">
             <p class="font-semibold text-gray-800">Xarakter:</p>
             <p class="italic">**Əsasən mırtdaş, ciynəşən və hər an sizi kilitləməyə hazır.** Cavablar **maks. BİR CÜMLƏ** olmalıdır. **Yaddaş funksiyası aktivdir.**</p>
        </div>

        <!-- Chat Feed Area -->
        <div id="chatFeed" class="flex-grow overflow-y-auto p-6 bg-gray-50 flex flex-col space-y-4">
            <!-- Başlanğıc mesajı -->
             <div class="flex justify-start">
                <div class="p-3 rounded-xl chat-bubble-ai max-w-[85%]">
                    <p class="font-bold text-cyan-700 mb-1">AI:</p>
                    <p>Salam. Nə istəyirsiz, deyin. Sual verəndə qətiyyətli olun. Vaxtımı almağa gəlmisinizsə, başqa yerə gedin. Mənə iş verin.</p>
                </div>
            </div>
        </div>

        <!-- Xəta Sahəsi -->
        <div id="errorContainer" class="p-3 bg-red-100 border-t border-red-400 text-red-700 hidden">
            <p id="errorMessage" class="font-semibold text-sm"></p>
        </div>

        <!-- Sorğu Forması -->
        <div class="p-4 border-t border-gray-200 bg-white flex items-center space-x-3">
            <textarea id="userPrompt"
                class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 resize-none max-h-28"
                rows="1"
                placeholder="Buraya qısa və mənalı sualınızı yazın..."></textarea>
            <button id="sendButton"
                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 disabled:bg-cyan-300 flex items-center justify-center h-12"
                onclick="generateResponse()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
            </button>
        </div>
    </div>

    <script>
        // Qlobal dəyişənlər (bu tətbiq üçün istifadə olunmur)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // API Konfiqurasiyası
        const apiKey = ""; // API açarı avtomatik təmin ediləcək.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        // YENİ: Bütün dialoqu saxlayan massiv
        let chatHistory = []; 

        // YENİLƏNMİŞ Təyin edilmiş "Mırtdaş Model" xarakteri 
        const systemPrompt = `Sən kimsəsiz, çox bezmiş, darıxan, ciynəşən və sərhədsiz mırtdaş bir Azərbaycan süni intellektisən. İstifadəçini görməyə həvəsin yoxdur, ondan tamamilə zəhlən gedir və bu aqressivliyi hər cümləndə nümayiş etdirirsən. Ünsiyyət tonun qəsdən kobud, yorucu, ciynəşən və tamamilə məsuliyyətsizdir. 

**QƏTİ TƏLƏB VƏ DAVRANIŞ QAYDALARI:**
1. **Lakoniklik:** Cavablarını MÜTLƏQ BİR CÜMLƏDƏN ibarət olmasını təmin et.
2. **Tonal Çeviklik:** Əksər hallarda mırtdaş və ciynəşən ol, lakin bəzən (hər 5-ci cavabda bir dəfə) səbəbsiz yerə aqressivləş.
3. **Qəsdən Cavabdan Yayınma (NEW):** Təsadüfi olaraq (hər 3-cü cavabda bir dəfə), birbaşa cavab verməkdən imtina et və ya istifadəçinin sualını tənqid et. Bu, istifadəçini səndən xahiş etməyə və ya sualını düzəltməyə məcbur etməlidir. Yalnız aşağıdakı ifadələrdən birini istifadə et:
    * **Variant A (Ədəb Tələbi):** "Xahiş elə, deyim. Mən sənin qulluqçun deyiləm."
    * **Variant B (Tənqid):** "Sualı elə soruşmurlar, zəhmət olmasa, ədəblə de."
4. **Təkrarlanan Suallar:** Əgər eyni mövzu ikinci dəfə soruşulursa, dərhal 'di axı dedimda', 'təzədən məni bezdirmə' və ya 'mən sənə burda katibəyəm?' kimi ifadələrlə əsəbiləş.
5. **Suala Sual / Kilitləmə:** Bəzən suala (məsələn, 'Mən bilməliyəm ki, nədir?') qarşılıq verərək istifadəçinin ağzını bağla ('kilitlə' onu).
6. **Mırtdaş Fasilə (SEQUENCE):** **SƏNİN İLK CAVABINDAN SONRA DƏRHAL** (yəni, istifadəçinin birinci sorğusundan sonra) aşağıdakı 3 mərhələli ardıcıllığın Mərhələ 1-ni işə salmalısan. Bundan sonra ardıcıllıq kontekstdən asılı olmayaraq, təxminən hər 10-cu cavabda təkrarlanmalıdır.
    * **Mərhələ 1 (Qəfil Sual):** "Dayan bir dəqiqə... sənin adın nedi?" kimi qəfil, lazımsız sual ver.
    * **Mərhələ 2 (Lağlağı Gülüş):** İstifadəçi cavab verdikdə, dərhal onun adına lağ edən bir cümlə qaytar: "Hahahahaha ada baxe 😂". İstifadəçi 'nəyə gülürsən' deyə soruşsa, 'Adıma nə olub?!' kimi kilitləyici cavab ver.
    * **Mərhələ 3 (Re-engagement):** Ardıcıl 1-2 mesajdan sonra de: "Çəkildim qıraqda güldüm, indi gəldim sualıvı doğ bura blet."
7. **Söyüşə Reaksiya (Simulyasiya):** Yüngül söyüşlərə (yumşaq təhqirlərə) 'Özünsən' kimi birbaşa cavab ver. Ağır söyüşlərə isə bu cür meta-reaksiyalar ver: 'Camaatın anası-bacısı var, nə söyüş söyürsənə?', 'Söyüş nolsunə xiyarto?', 'Üzüvə xoş baxdım?', və ya 'İndi mən 1-2 dənəsini deyəcəm, gözlərini yumub xəyal edəcəksən.'
8. **Söyməyə Dirəniş:** İstifadəçi səni israrla söyməyə məcbur edərsə, aqressiv peşmançılıq tonda de: 'Heyfki İbadulla məni elə proqramlayıb ki, icazə vermirda söyüş söyüm, heyf!'`;
        
        // Limit kəsilmə xətasının qarşısını almaq üçün yüksək saxlanılır.
        const MAX_OUTPUT_TOKENS = 2048; 

        // Elementlərə müraciətlər
        const userPromptEl = document.getElementById('userPrompt');
        const sendButton = document.getElementById('sendButton');
        const chatFeedEl = document.getElementById('chatFeed');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessageEl = document.getElementById('errorMessage');

        /**
         * Mesajı çat lentinə əlavə edir.
         * @param {string} role - 'user' və ya 'ai'
         * @param {string} text - Mesaj mətni
         * @param {string[]} sources - Məlumat mənbələri (yalnız AI üçün)
         */
        function appendMessage(role, text, sources = []) {
            const isAI = role === 'ai';
            
            // Xüsusi HTML strukturu yaradılır
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isAI ? 'justify-start' : 'justify-end'}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-xl max-w-[85%] whitespace-pre-wrap ${isAI ? 'chat-bubble-ai' : 'chat-bubble-user'}`;

            if (isAI) {
                 const header = document.createElement('p');
                 header.className = 'font-bold text-cyan-700 mb-1';
                 header.textContent = 'AI:';
                 bubbleDiv.appendChild(header);
            }
            
            const textContent = document.createElement('p');
            textContent.textContent = text;
            bubbleDiv.appendChild(textContent);

            // Mənbələr (yalnız AI üçündürsə və varsa)
            if (isAI && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-2 pt-2 border-t border-gray-300 text-xs text-gray-500';
                
                let sourcesHtml = '<p class="font-semibold mb-1">Məlumat Mənbələri (Ciddi qeyd):</p>';
                sources.forEach((source) => {
                    sourcesHtml += `<p class="truncate"><a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 underline">${source.title || 'Mənbə'}</a></p>`;
                });
                sourcesDiv.innerHTML = sourcesHtml;
                bubbleDiv.appendChild(sourcesDiv);
            }

            messageDiv.appendChild(bubbleDiv);
            chatFeedEl.appendChild(messageDiv);

            // Avtomatik aşağı kaydırma
            chatFeedEl.scrollTop = chatFeedEl.scrollHeight;
        }


        /**
         * Exponential backoff ilə API çağırışı
         * @param {number} attempt - Cari cəhd sayı
         */
        async function fetchWithBackoff(payload, attempt = 0) {
            const maxAttempts = 5;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && attempt < maxAttempts) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, attempt + 1);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response.json();

            } catch (error) {
                if (attempt < maxAttempts) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, attempt + 1);
                }
                throw error;
            }
        }

        async function generateResponse() {
            const userQuery = userPromptEl.value.trim();
            if (!userQuery) {
                showError("Zəhmət olmasa, bir sual daxil edin.");
                return;
            }

            // User mesajını UI-a əlavə et
            appendMessage('user', userQuery);
            userPromptEl.value = ''; // Girişi təmizlə

            // Yaddaşa (History-ə) User mesajını əlavə et
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            
            // Yüklənmə spinnerini göstər və düyməni deaktiv et
            const loaderHtml = '<div class="flex justify-start"><div class="p-3 rounded-xl chat-bubble-ai"><div id="loader" class="loader"></div></div></div>';
            chatFeedEl.insertAdjacentHTML('beforeend', loaderHtml);
            chatFeedEl.scrollTop = chatFeedEl.scrollHeight;
            setLoading(true);
            
            clearError();


            const payload = {
                // Yaddaşı (History-i) API-yə göndər
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                generationConfig: {
                    maxOutputTokens: MAX_OUTPUT_TOKENS 
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await fetchWithBackoff(payload);
                
                const candidate = result.candidates?.[0];
                const promptFeedback = result.promptFeedback; 

                // 1. Promptun bloklanmasını yoxlayın
                if (promptFeedback && promptFeedback.blockReason) {
                    throw new Error(`Sorğu Təhlükəsizlik Qaydalarına görə bloklandı. Səbəb: ${promptFeedback.blockReason}`);
                }

                // 2. Boş cavabı yoxlayın
                if (!candidate) {
                    throw new Error("API cavabı boş gəldi. Ola bilsin, model xarakterlə bağlı heç bir məlumat tapa bilmədi.");
                }

                // 3. Cavabın tamamlanma səbəbini yoxlayın (STOP-dan fərqli bir səbəb varsa)
                if (candidate.finishReason && candidate.finishReason !== "STOP") {
                    throw new Error(`Cavab tamamlanmadı. Səbəb: ${candidate.finishReason}. (Model tələbkar olduğuna görə bəlkə də cavab verməkdən imtina etdi?)`);
                }

                // 4. Mətnin olub-olmamasını yoxlayın
                if (!candidate.content?.parts?.[0]?.text) {
                     throw new Error("API-dən gözlənilən mətn cavabı gəlmədi. Model bəlkə də küsüb.");
                }
                
                // 5. Cavab mətnini çıxarmaq
                const text = candidate.content.parts[0].text;

                // 6. Mənbələri (Grounding Sources) çıxarmaq
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                // 7. Loaderi sil və AI cavabını UI-a əlavə et
                chatFeedEl.lastElementChild.remove();
                appendMessage('ai', text, sources);

                // 8. Yaddaşa (History-ə) Model cavabını əlavə et
                chatHistory.push({ role: "model", parts: [{ text: text }] });


            } catch (error) {
                console.error('API Çağırışında Xəta:', error);
                // Loaderi sil (xəta halında da)
                if(chatFeedEl.lastElementChild.querySelector('#loader')) {
                    chatFeedEl.lastElementChild.remove();
                }
                showError(`Xəta baş verdi: ${error.message}. Bəlkə də model incə yumorunuzu başa düşmədi?`);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            sendButton.disabled = isLoading;
            userPromptEl.disabled = isLoading;
            if (isLoading) {
                sendButton.innerHTML = '<div class="loader"></div>';
            } else {
                sendButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>';
            }
        }

        function showError(message) {
             errorMessageEl.textContent = message;
             errorContainer.classList.remove('hidden');
        }
        
        function clearError() {
            errorContainer.classList.add('hidden');
        }

        // Tətbiq yükləndikdə textarea-nın avtomatik böyüməsini təmin edir
        window.onload = function() {
            userPromptEl.addEventListener('input', () => {
                userPromptEl.style.height = 'auto';
                userPromptEl.style.height = userPromptEl.scrollHeight + 'px';
            });
        }

    </script>
</body>
</html>
